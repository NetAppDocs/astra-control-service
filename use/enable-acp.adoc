---
sidebar: sidebar
permalink: use/enable-acp.html
keywords: Astra Control Provisioner install, acp, enable, astra trident upgrade, upgrade trident
summary: Enable Astra Control Provisioner to access advanced storage provisioning and management functionality.
---

= Enable Astra Control Provisioner
:hardbreaks:
:icons: font
:imagesdir: ../media/use/

[.lead]
Astra Trident versions 23.10 and later include the option to use Astra Control Provisioner, which enables licensed Astra Control users to access advanced storage provisioning functionality. Astra Control Provisioner provides this extended functionality in addition to standard Astra Trident CSI-based functionality. 

Your Astra Control Service subscription automatically includes the license for Astra Control Provisioner use.

In coming Astra Control updates, Astra Control Provisioner will replace Astra Trident as storage provisioner and orchestrator in the Astra Control architecture. Because of this, it's highly recommended that Astra Control users enable Astra Control Provisioner. Astra Trident will continue to remain open source and be released, maintained, supported, and updated with new CSI and other features from NetApp.

.How do I know if I need to enable Astra Control Provisioner?

If you add a cluster to Astra Control Service that does not have Astra Trident previously installed, the cluster will be marked as `Eligible`. After you link:../get-started/add-first-cluster.html[add the cluster to Astra Control], Astra Control Provisioner will be automatically enabled. 

If your cluster is not marked `Eligible`, it will be marked `Partially eligible` because of one of the following:

* It's using an older version of Astra Trident
* It's using an Astra Trident 23.10 that does not yet have the provisioner option enabled
* It's a cluster type that does not allow automatic enablement

For `Partially eligible` cases, use these instructions to manually enable Astra Control Provisioner for your cluster.

image:ac-acp-eligibility.png[A screenshot depicting cluster eligibility in the Add cluster workflow]

.Before you enable Astra Control Provisioner

If you have an existing Astra Trident without Astra Control Provisioner and want to enable Astra Control Provisioner, do the following first:

* *Confirm that your Astra Trident version is within a four-release window*: You can perform a direct upgrade to Astra Trident 23.10 with Astra Control Provisioner if your Astra Trident is within a four-release window of version 23.10. For example, you can directly upgrade from Astra Trident 22.10 to 23.10.

* *Confirm that your cluster has an AMD64 system architecture*: The Astra Control Provisioner image is provided in both AMD64 and ARM64 CPU architectures, but only AMD64 is supported by Astra Control.

.Upgrade to Astra Control Provisioner 23.10

If you upgraded your Astra Trident to version 23.10, you can use this procedure to enable and install Astra Control Provisioner.

.Steps

. Access the NetApp Astra Control image registry:
+
.Expand for steps
[%collapsible]
=====

.. Log on to the Astra Control Service UI and record your Astra Control account ID.

... Select the figure icon at the top right of the page. 
... Select *API access*. 
... Write down your account ID.

.. From the same page, select *Generate API token* and copy the API token string to the clipboard and save it in your editor.

.. Log into the Astra Control registry using your preferred method:
+
[source,docker]
----
docker login cr.astra.netapp.io -u <account-id> -p <api-token>
----
+
[source,crane]
----
crane auth login cr.astra.netapp.io -u <account-id> -p <api-token>
----
=====

. Follow the steps for your preferred method to move the image to your custom registry. If you aren't using a registry, follow the Trident operator steps to set up a secret. 
+
NOTE: You can use Podman instead of Docker for the following commands. If you are using a Windows environment, PowerShell is recommended.
+
[role="tabbed-block"]
====
.Docker
--

. Pull the Astra Control Provisioner image from the registry:
+
NOTE: The image pulled will not support multiple platforms and will only support the same platform as the host that pulled the image, such as Linux AMD64.
+
[source,console]
----
docker pull cr.astra.netapp.io/astra/trident-acp:23.10.0
----

. Tag the image:
+
[source,console]
----
docker tag cr.astra.netapp.io/astra/trident-acp:23.10.0 <my_custom_registry>/trident-acp:23.10.0
----

. Push the image to your custom registry:
+
[source,console]
----
docker push <my_custom_registry>/trident-acp:23.10.0
----
--
// end docker tab block

.Crane
--

. Copy the Astra Control Provisioner manifest to your custom registry:
+
----
crane copy cr.astra.netapp.io/astra/trident-acp:23.10.0 <my_custom_registry>/trident-acp:23.10.0
----
--
// end crane tab block

.Trident Operator
--

. Ensure this block is present in your Docker configuration:
+
----
{
    "auths": {
        "https://cr.astra.netapp.io/": {
            "auth": "c3R...zE2"
        }
    }
}
----

. [[pull-secrets]]Create a secret in the `trident` namespace:
+
----
kubectl create secret -n <trident namespace> generic <secret name> \
    --from-file=.dockerconfigjson=<path/to/.docker/config.json> \
    --type=kubernetes.io/dockerconfigjson
----

. Add the secret to TORC (Astra Trident orchestrator):
+
----
apiVersion: trident.netapp.io/v1
kind: TridentOrchestrator
metadata:
  name: trident
spec:
  debug: true
  namespace: trident
  tridentImage: netapp/trident:23.10.0
  imagePullSecrets:
  - <secret name>
----
--
// end trident tab block
====
// end overall tabbed block
//kubectl plugin required for next step? Where does user get it?
//. Push the Astra Control Provisioner image to your custom registry:
//+
//.Expand for steps
//[%collapsible]
//=====
//
//.. Change to the root directory of the tarball.
//
//.. Push the Astra Control Provisioner image to your custom registry. Make the following substitutions before running the `push-images` command:
//+
//
//* Replace <BUNDLE_FILE> with the name of the Astra Control Provisioner bundle file (`acp.manifest.bundle.yaml`).
//* Replace <MY_FULL_REGISTRY_PATH> with the URL of the Docker repository; for example, "https://<docker-registry>".
//* Replace <MY_REGISTRY_USER> with the user name.
//* Replace <MY_REGISTRY_TOKEN> with an authorized token for the registry.
//+
//[source,console]
//----
//kubectl astra packages push-images -m <BUNDLE_FILE> -r <MY_FULL_REGISTRY_PATH> -u <MY_REGISTRY_USER> -p <MY_REGISTRY_TOKEN>
//----
//=====

. Determine if the original Astra Trident installation method used an https://docs.netapp.com/us-en/trident/trident-managing-k8s/uninstall-trident.html#determine-the-original-installation-method[operator (either manually or with Helm) or `tridentctl`^].
+
WARNING: Do not use Helm to enable Astra Control Provisioner. If you used Helm for the original installation and you are upgrading to 23.10, you'll need to use either the Trident operator or tridentctl to perform Astra Control Provisioner enablement.
+
[role="tabbed-block"]
====
.Astra Trident operator
--
//. Delete the Trident operator that was used to install the current Astra Trident instance. For example, if you are upgrading from Astra Trident 23.07, run the following command:
//+
//----
//kubectl delete -f 23.07/trident-installer/deploy/<bundle-name.yaml> -n trident
//----
. Edit the TridentOrchestrator CR and make the following edits:
+
* Enable Astra Control Provisioner (`enableACP: true`)
* Set the registry location for the Astra Control Provisioner image (`acpImage: <my_custom_registry>/trident-acp:v23.10.0`). 
+
NOTE: If you established <<pull-secrets,image pull secrets>> earlier in this procedure, you can use them here (`cr.astra.netapp.io/astra/trident-acp:23.10.0 imagePullSecrets: - <secret-name>`)

+
[subs=+quotes]
----
apiVersion: trident.netapp.io/v1
kind: TridentOrchestrator
metadata:
  name: trident
spec:
  debug: true
  namespace: trident
  *enableACP: true*
  *acpImage: <my_custom_registry>/trident-acp:v23.10.0*
----
. Apply the changes:
+
----
kubectl -n trident apply -f tridentorchestrator_cr.yaml
----

. Update Astra Trident configuration so that the new `trident-acp` container is deployed:
+
NOTE: For clusters running Kubernetes 1.24 or earlier, use `bundle_pre_1_25.yaml`. For clusters running Kubernetes 1.25 or later, use `bundle_post_1_25.yaml`.
+
----
kubectl -n trident apply -f trident-installer-23.10.0/deploy/<bundle-name.yaml>
----

. Verify the operator, deployment, and replicasets were created.
+
----
kubectl get all -n <operator-namespace>
----

+
IMPORTANT: There should only be *one instance* of the operator in a Kubernetes cluster. Do not create multiple deployments of the Trident operator.

. Verify the `trident-acp` container is running and that `acpVersion` is `23.10.0` with a status of `Installed`:
+
----
kubectl get torc -o yaml
----
+
Response:
+
----
status:
  acpVersion: 23.10.0
  currentInstallationParams:
    ...
    acpImage: <my_custom_registry>/trident-acp:v23.10.0
    enableACP: "true"
    ...
  ...
  status: Installed
----
--

.tridentctl
--
. https://docs.netapp.com/us-en/trident/trident-managing-k8s/upgrade-tridentctl.html[Uninstall Astra Trident^].
. Install Astra Trident again with Astra Control Provisioner enabled (`--enable-acp=true`):
+
----
./tridentctl -n trident install --enable-acp=true --acp-image=mycustomregistry/trident-acp:v23.10
----

. Confirm that Astra Control Provisioner has been enabled:
+
----
./tridentctl -n trident version
----
+
Response:
+
----
+----------------+----------------+-------------+ | SERVER VERSION | CLIENT VERSION | ACP VERSION | +----------------+----------------+-------------+ | 23.10.0 | 23.10.0 | 23.10.0. | +----------------+----------------+-------------+
----

====
// end tabbed block

.Result

After Astra Control Provisioner is installed, the cluster hosting the provisioner in the Astra Control UI will show an `ACP version` rather than `Trident version` field and current installed version number.

image:ac-acp-version.png[A screenshot depicting the ACP version location in UI]

.For more information

* https://docs.netapp.com/us-en/trident/trident-managing-k8s/upgrade-operator-overview.html[Astra Trident upgrades documentation^]